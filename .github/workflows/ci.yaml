name: Integration

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
  merge_group:
env:
  CI: true

jobs:
  integration-checks:
    name: Integration Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build devcontainer and run tests
        uses: devcontainers/ci@v0.3
        with:
          cacheFrom: ghcr.io/ecoma-io/devcontainer
          push: never
          runCmd: |
            bash .devcontainer/tests/smoke-test.sh

  static-checks:
    name: Static Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run Gitleaks via Docker
        run: |
          docker run -v $(pwd):/path \
            -e GITLEAKS_LICENSE=${{ secrets.GITLEAKS_LICENSE }} \
            zricethezav/gitleaks:latest \
            detect --source="/path" \
            --verbose \
            --redact \
            --exit-code=2

      - name: Checking dprint formatting
        uses: dprint/check@v2.3

      - name: Shellcheck
        uses: ludeeus/action-shellcheck@master

  release:
    # Release job: runs only on push to main and creates a release via
    # googleapis/release-please-action. Uses a GitHub App token generated
    # earlier in the steps to allow write access for tagging/release creation.
    name: Release
    needs: [integration-checks, static-checks]
    if: ${{ github.event_name == 'push' }}
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.pushed-image.outputs.released  }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Generate App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.ECOMA_APP_ID }}
          private_key: ${{ secrets.ECOMA_APP_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.generate_token.outputs.token }}

      - name: Release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        id: release-please
        with:
          token: ${{ steps.generate_token.outputs.token }}
          release-type: go

      - name: Login to GitHub Container Registry
        if: steps.release-please.outputs.release_created == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        if: steps.release-please.outputs.release_created == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Pre-build dev container image
        if: steps.release-please.outputs.release_created == 'true'
        uses: devcontainers/ci@v0.3
        with:
          imageName: ghcr.io/ecoma-io/devcontainer
          imageTag: latest,${{ github.sha }},${{ steps.release-please.outputs.version }},${{ steps.release-please.outputs.major }}.${{ steps.release-please.outputs.minor }},${{ steps.release-please.outputs.major }}
          push: always

      - name: Output created image tags
        if: steps.release-please.outputs.release_created == 'true'
        id: pushed-image
        shell: bash
        run: echo "released=true" >> $GITHUB_OUTPUT

  security-scan:
    name: Security Scan
    needs: release
    if: needs.release.outputs.released == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan image with Trivy
        run: |
          set -euo pipefail
          IMAGE=ghcr.io/ecoma-io/devcontainer:latest
          OUT="${{ github.workspace }}/trivy.sarif"
          docker pull "$IMAGE"
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "${{ github.workspace }}":/workspace\
            ghcr.io/aquasecurity/trivy:latest image \
            --exit-code 0 \
            --format sarif \
            --output /workspace/trivy.sarif "$IMAGE" || true

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ github.workspace }}/trivy.sarif
          category: Trivy

  report:
    # Reporting job: always runs (even if previous jobs are skipped/failed)
    # and sets a GitHub status via an external action.
    name: Report
    needs: [static-checks, integration-checks, release]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Setup project
        uses: guibranco/github-status-action-v2@latest
        with:
          authToken: ${{secrets.GITHUB_TOKEN}}
          context: ci-completed
          state: ${{ (needs.static-checks.result != 'failure' && needs.integration-checks.result != 'failure' && needs.release.result != 'failure') && 'success' || 'failure' }}
          sha: ${{github.event.pull_request.head.sha || github.sha}}
